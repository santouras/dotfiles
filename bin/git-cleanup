#!/bin/bash

# -m Removes local branches that have been merged into the current branch
# -b Rebases against where current branch diverged from master
# -r Cleanups all remotes
# -x Rebases against tracking branch
# -a Checks out master, fetch and ff, then prune merged and remotes
# @author Jude Aakjaer

prune_merged_branches ()
{
  branches=$(git branch --merged | grep -v "\*")

  if [ $? -ne 0 ]; then
    echo "No branches to cleanup"
    return
  fi

  echo $branches | xargs -n 1 git branch -d
}

prune_remotes ()
{
  git remote | xargs -n 1 git remote prune
}

rebase_against_origin_master ()
{
  git fetch origin
  git rebase origin/master
}

rebase_against_branched ()
{
  git rebase -i $(git merge-base HEAD master)
}

while getopts ":xbram" opt; do
  case $opt in
    x)
      rebase_against_origin_master
      ;;
    a)
      git checkout master
      git fetch
      git ff
      prune_merged_branches
      prune_remotes
      ;;
    m) prune_merged_branches
      ;;
    r) prune_remotes
      ;;
    b) rebase_against_branched
      ;;
    \?)
      echo "Invalid option: -$OPTARG" >&2
      exit 1
      ;;
  esac
done

